<routes xmlns="http://camel.apache.org/schema/spring">

	<route id="odoo-process-revision-or-dc-order" errorHandlerRef="watcherErrorHandler">
		<from uri="direct:odoo-process-revision-or-dc-order" />

		<log message="Start: route with id ${routeId}" loggingLevel="DEBUG" />

		<to uri="direct:odoo-get-order-line" />

		<choice>
			<when>
				<simple>${body.length} > 1</simple>
				<throwException exceptionType="org.openmrs.eip.component.exception.EIPException" message="Found multiple(${body.length}) lines for the same product added to the quotation in odoo" />
			</when>
			<when>
				<simple>${body.length} == 0</simple>
				<log message="No order line found on the quotation in odoo" loggingLevel="DEBUG" />

				<when>
					<simple>${exchangeProperty.order-instance.action} == 'REVISE'</simple>
					<setProperty name="odoo-operation">
						<simple>write</simple>
					</setProperty>
					<log message="Adding new order line to the quotation" />

					<to uri="direct:odoo-manage-order-line" />
				</when>
			</when>
			<otherwise>
				<log message="Found existing order line in odoo on the quotation for the orderable" />
				<choice>
					<when>
						<simple>${exchangeProperty.order-quantity} != ${body[0].get('product_uom_qty')}</simple>
						<log message="Orderable quantity changed from ${body[0].get('product_uom_qty')} to ${exchangeProperty.order-quantity}" />

						<setProperty name="order-line-id">
							<simple>${body[0].get('id')}</simple>
						</setProperty>
						<setProperty name="odoo-operation">
							<simple>create</simple>
						</setProperty>

						<to uri="direct:odoo-manage-order-line" />
					</when>
					<when>
						<simple>${exchangeProperty.order-instance.action} == 'DISCONTINUE'</simple>
						<log message="Removing order line from the quotation in odoo" />

						<setProperty name="order-line-id">
							<simple>${body[0].get('id')}</simple>
						</setProperty>
						<setProperty name="odoo-operation">
							<simple>unlink</simple>
						</setProperty>

						<to uri="direct:odoo-manage-order-line" />
					</when>
					<otherwise>
						<log message="Order quantity is the same as that in odoo, nothing to update" />
					</otherwise>
				</choice>
			</otherwise>
		</choice>

		<when>
			<simple>${exchangeProperty.order-instance.action} == 'DISCONTINUE' &amp;&amp; ${exchangeProperty.order-line-count} &lt; 2</simple>
			<log message="Deleting the quotation because it has no more order lines left" />

			<setProperty name="odoo-operation">
				<simple>unlink</simple>
			</setProperty>

			<to uri="direct:odoo-manage-quotation" />
		</when>

		<log message="End: route with id ${routeId}" loggingLevel="DEBUG" />
	</route>

</routes>
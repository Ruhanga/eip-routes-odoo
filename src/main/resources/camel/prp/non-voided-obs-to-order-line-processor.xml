<routes xmlns="http://camel.apache.org/schema/spring">

	<route id="non-voided-obs-to-order-line-processor" errorHandlerRef="watcherErrorHandler">
		<from uri="direct:non-voided-obs-to-order-line-processor" />

		<log loggingLevel="DEBUG" message="Start: route with id ${routeId}" />

        <setProperty name="unitsName">
            <simple>{{odoo.physio.session.units.name}}</simple>
        </setProperty>

        <to uri="direct:get-units-id-by-name-from-odoo" />

        <when>
            <simple>${body.length} > 1</simple>
            <throwException exceptionType="org.openmrs.eip.EIPException" message="Found ${body.length} units in odoo matching name: ${exchangeProperty.unitsName}" />
        </when>

        <choice>
            <when>
                <simple>${body.length} == 0</simple>
                <throwException exceptionType="org.openmrs.eip.EIPException" message="No unit found in odoo matching name: ${exchangeProperty.unitsName}" />
            </when>
            <otherwise>
                <setProperty name="unitsId">
                    <simple>${body[0]}</simple>
                </setProperty>

                <log loggingLevel="DEBUG" message="Odoo physio sessions units of measure id: ${exchangeProperty.unitsId}" />
            </otherwise>
        </choice>

        <setProperty name="order-quantity">
            <simple>${exchangeProperty.entity-instance.get('value')}</simple>
        </setProperty>

        <choice>
            <when>
                <simple>${exchangeProperty.order-line} == null</simple>
                <setProperty name="odoo-operation">
                    <simple>create</simple>
                </setProperty>

                <log message="Adding new item to the quotation" />

                <to uri="direct:odoo-manage-order-line" />
            </when>
            <otherwise>
                <when>
                    <simple>${exchangeProperty.order-quantity} != ${exchangeProperty.order-line.get('product_uom_qty')}</simple>
                    <log message="Item quantity changed from ${exchangeProperty.order-line.get('product_uom_qty')} to ${exchangeProperty.order-quantity}" />

                    <setProperty name="hasChanges">
                        <simple>true</simple>
                    </setProperty>
                </when>

                <when>
                    <simple>${exchangeProperty.unitsId} != ${exchangeProperty.order-line.get('product_uom')[0]}</simple>
                    <log message="Item quantity units changed from ${exchangeProperty.order-line.get('product_uom')[0]} to ${exchangeProperty.unitsId}" />

                    <setProperty name="hasChanges">
                        <simple>true</simple>
                    </setProperty>
                </when>

                <choice>
                    <when>
                        <simple>${exchangeProperty.hasChanges} == true</simple>
                        <setProperty name="odoo-operation">
                            <simple>write</simple>
                        </setProperty>

                        <log message="Found changes, updating existing item on the quotation" />

                        <to uri="direct:odoo-manage-order-line" />
                    </when>
                    <otherwise>
                        <log message="Item quantity and units are the same as those on the existing item in odoo, nothing to update" />
                    </otherwise>
                </choice>
            </otherwise>
        </choice>

		<log loggingLevel="DEBUG" message="End: route with id ${routeId}" />
	</route>

</routes>

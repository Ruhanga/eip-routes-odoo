<routes xmlns="http://camel.apache.org/schema/spring">

	<route id="odoo-process-revision-or-dc-order" errorHandlerRef="watcherErrorHandler">
		<from uri="direct:odoo-process-revision-or-dc-order" />

		<log message="Processing revision order.." loggingLevel="DEBUG" />

		<to uri="direct:odoo-get-quotations" />

		<log message="Found ${body.length} existing quotation(s) for the patient in Odoo" loggingLevel="DEBUG" />

		<choice>
			<when>
				<simple>${body.length} > 1</simple>
				<throwException exceptionType="org.openmrs.eip.component.exception.EIPException" message="Found ${body.length} existing quotation(s) for the same patient created by this system in odoo" />
			</when>
			<when>
				<simple>${body.length} == 0</simple>
				<!-- What happened to it? Possibly the original order was placed before this application was in use, Instantiate and create a new quotation -->
			</when>
			<otherwise>
				<log message="Existing quotation id: ${body[0].get('id')}" loggingLevel="DEBUG" />
				<setProperty name="quotation-id">
					<spel>#{T(java.lang.Integer).valueOf(body[0].get('id'))}</spel>
				</setProperty>
				
				<to uri="direct:odoo-get-order-line" />

				<choice>
					<when>
						<simple>${body.length} > 1</simple>
						<throwException exceptionType="org.openmrs.eip.component.exception.EIPException" message="Found multiple(${body.length}) lines for the same product added to the quotation in odoo" />
					</when>
					<when>
						<simple>${body.length} == 0</simple>

						<log message="Adding order line to the quotation in odoo" />

						<to uri="direct:odoo-manage-order-line" />
					</when>
					<otherwise>
						<log message="Found existing order line in odoo on the quotation for orderable with qty: ${body[0].get('product_uom_qty')}" />
						<choice>
							<when>
								<simple>${exchangeProperty.order-quantity} != ${body[0].get('product_uom_qty')}</simple>
								<log message="Updating existing orderable quantity to: ${exchangeProperty.order-quantity}" />

								<setProperty name="order-line-id">
									<simple>${body[0].get('id')}</simple>
								</setProperty>

								<log message="Updating quantity for the order line in odoo" />
								
								<to uri="direct:odoo-manage-order-line" />
							</when>
							<otherwise>
								<log message="Order quantity is the same as that in odoo, nothing to update" />
							</otherwise>
						</choice>
					</otherwise>
				</choice>

			</otherwise>
		</choice>

		<log message="Successfully processed revision order" loggingLevel="DEBUG" />
	</route>

</routes>
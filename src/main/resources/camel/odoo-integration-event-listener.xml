<routes xmlns="http://camel.apache.org/schema/spring">

    <route id="odoo-event-listener" errorHandlerRef="watcherErrorHandler">
        <from uri="direct:odoo-event-listener" />

        <log message="Received DB event: ${exchangeProperty.event}" loggingLevel="DEBUG" />

		<setProperty name="tables-repo-map">
			<spel>#{new java.util.HashMap(6)}</spel>
		</setProperty>

		<script>
			<spel>
				#{getProperty('tables-repo-map').put('orders', 'orderRepository')}
				#{getProperty('tables-repo-map').put('test_order', 'orderRepository')}
				#{getProperty('tables-repo-map').put('drug_order', 'orderRepository')}
				#{getProperty('tables-repo-map').put('patient', 'patientRepository')}
				#{getProperty('tables-repo-map').put('person_name', 'personNameRepository')}
				#{getProperty('tables-repo-map').put('person_address', 'personAddressRepository')}
			</spel>
		</script>

        <when>
            <simple>${exchangeProperty.event.snapshot} == false || ${exchangeProperty.tables-repo-map.containsKey(exchangeProperty.event.tableName)} == true</simple>
            <log message="Processing event..." />
            <log message="Loading entity from DB..." loggingLevel="DEBUG" />

            <setBody>
                <spel>#{exchange.context.registry.lookupByName(getProperty("tables-repo-map").get(getProperty('event').tableName)).findByUuid(getProperty('event').identifier)}</spel>
            </setBody>

            <log message="Loaded entity -> ${body}" loggingLevel="DEBUG" />

            <choice>
                <when>
                    <simple>${body} != null</simple>
                    <setProperty name="entity-instance">
                        <simple>${body}</simple>
                    </setProperty>

                    <toD uri="direct:odoo-authentication" />

                    <setProperty name="odoo-user-id">
                        <simple>${body}</simple>
                    </setProperty>

                    <choice>
                        <when>
                            <simple>${exchangeProperty.event.tableName} == 'orders' || ${exchangeProperty.event.tableName} == 'test_order' || ${exchangeProperty.event.tableName} == 'drug_order'</simple>
                            <log message="Processing Order" loggingLevel="DEBUG" />

                            <to uri="direct:odoo-order-handler" />
                        </when>
                        <when>
                            <simple>${exchangeProperty.event.tableName} == 'patient'</simple>
                            <setProperty name="patient">
                                <simple>${exchangeProperty.entity-instance}</simple>
                            </setProperty>
                            
                            <log message="Processing Patient" loggingLevel="DEBUG" />

                            <to uri="direct:odoo-patient-handler" />
                        </when>
                        <when>
                            <simple>${exchangeProperty.event.tableName} == 'person_name' || ${exchangeProperty.event.tableName} == 'person_address'</simple>
                            <choice>
                                <when>
                                    <simple>${exchangeProperty.event.tableName} == 'person_name'</simple>
                                    <setProperty name="patientAssociationName">
                                        <simple>Person Name</simple>
                                    </setProperty>
                                </when>
                                <otherwise>
                                    <setProperty name="patientAssociationName">
                                        <simple>Person Address</simple>
                                    </setProperty>
                                </otherwise>
                            </choice>

                            <log message="Processing ${exchangeProperty.patientAssociationName}" loggingLevel="DEBUG" />

                            <to uri="direct:odoo-person-name-and-address-handler" />
                        </when>
                    </choice>

                    <log message="Done processing event!" />
                </when>
                <otherwise>
                    <log message="No entity found with uuid: ${exchangeProperty.event.identifier}" loggingLevel="WARN" />
                </otherwise>
            </choice>
        </when>
        
    </route>

</routes>
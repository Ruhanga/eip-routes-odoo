<routes xmlns="http://camel.apache.org/schema/spring">
    <route id="odoo-obs-handler" errorHandlerRef="watcherErrorHandler">
        <from uri="direct:odoo-obs-handler" />

		<log loggingLevel="DEBUG" message="Start: route with id ${routeId}" />

        <setProperty name="isInsertOrUpdate">
            <spel>#{getProperty('event').operation == 'c' || getProperty('event').operation == 'u'}</spel>
        </setProperty>

        <choice>
            <when>
                <simple>${exchangeProperty.entity-instance.get('voided')} != true &amp;&amp; ${exchangeProperty.isInsertOrUpdate} == true</simple>
                <setProperty name="obsQnAnsMapKey">
                    <simple>${routeId}-obsQnAnsMap</simple>
                </setProperty>

                <setProperty name="obsQnAnsMap">
                    <method beanType="org.openmrs.eip.AppContext" method="get(${exchangeProperty.obsQnAnsMapKey})" />
                </setProperty>

                <when>
                    <simple>${exchangeProperty.obsQnAnsMap} == null</simple>

                    <log message="Initializing Obs Question Answer Map"/>

                    <setProperty name="obsQnAnsMap">
                        <spel>#{new java.util.HashMap()}</spel>
                    </setProperty>

                    <split parallelProcessing="false">
                        <simple>{{odoo.obs.concept.question.answer.mappings}}</simple>
                        <setProperty name="obsQn">
                            <simple>${body.split(":")[0].trim()}</simple>
                        </setProperty>
                        <setProperty name="obsAnswers">
                            <simple>${body.split(":")[1].trim()}</simple>
                        </setProperty>
                        <setProperty name="obsAnswerSet">
                            <spel>#{new java.util.HashSet()}</spel>
                        </setProperty>

                        <!-- TODO Check the question concept datatype -->

                        <split parallelProcessing="false" >
                            <spel>#{T(org.apache.commons.lang3.StringUtils).split(getProperty('obsAnswers'), '^')}</spel>

                            <script>
                                <simple>${exchangeProperty.obsAnswerSet.add(${body.trim()})}</simple>
                            </script>
                        </split>

                        <script>
                            <spel>
                                #{getProperty('obsQnAnsMap').put(getProperty('obsQn'), getProperty('obsAnswerSet'))}
                            </spel>
                        </script>

                        <script>
                            <spel>
                                #{T(org.openmrs.eip.AppContext).add(getProperty('obsQnAnsMapKey'), getProperty('obsQnAnsMap'))}
                            </spel>
                        </script>
                    </split>

                    <log loggingLevel="DEBUG" message="Obs Question Answer Map -> ${exchangeProperty.obsQnAnsMap}"/>
                </when>

                <setProperty name="obsQnUuid">
                    <simple>${exchangeProperty.entity-instance.get('concept').get('uuid')}</simple>
                </setProperty>

                <choice>
                    <when>
                        <spel>#{getProperty('obsQnAnsMap').containsKey(getProperty('obsQnUuid'))}</spel>

                        <log loggingLevel="DEBUG" message="Obs has configured question concept" />

                        <choice>
                            <when>
                                <spel>#{getProperty('obsQnAnsMap').get(getProperty('obsQnUuid')).contains(getProperty('entity-instance').get('value').get('uuid'))}</spel>

                                <log message="Obs has configured question and answer concepts" />

                                <log message="Fetching patient associated to the Obs from OpenMRS..." />

                                <setProperty name="isSubResource">
                                    <simple>false</simple>
                                </setProperty>
                                <setProperty name="resourceName">
                                    <simple>patient</simple>
                                </setProperty>
                                <setProperty name="resourceId">
                                    <simple>${exchangeProperty.entity-instance.get('person').get('uuid')}</simple>
                                </setProperty>

                                <to uri="direct:odoo-fetch-resource" />

                                <choice>
                                    <when>
                                        <simple>${body} != null</simple>
                                        <setProperty name="patient">
                                            <jsonpath>$</jsonpath>
                                        </setProperty>

                                        <log loggingLevel="DEBUG" message="Fetched patient -> ${exchangeProperty.patient}" />

                                        <setProperty name="createCustomerIfNotExist">
                                            <simple>true</simple>
                                        </setProperty>

                                        <to uri="direct:odoo-patient-handler" />
                                    </when>
                                    <otherwise>
                                        <log message="No associated patient found with uuid: ${exchangeProperty.resourceId}" />
                                    </otherwise>
                                </choice>
                            </when>
                            <otherwise>
                                <log loggingLevel="DEBUG" message="Skipping Obs because the answer concept doesn't match any configured answer" />
                            </otherwise>
                        </choice>
                    </when>
                    <otherwise>
                        <log loggingLevel="DEBUG" message="Skipping Obs because the question concept doesn't match any configured question" />
                    </otherwise>
                </choice>
            </when>
            <otherwise>
                <choice>
                    <when>
                        <simple>${exchangeProperty.isInsertOrUpdate} != true</simple>
                        <log loggingLevel="DEBUG" message="Skipping deleted obs" />
                    </when>
                    <otherwise>
                        <log loggingLevel="DEBUG" message="Skipping voided obs" />
                    </otherwise>
                </choice>
            </otherwise>
        </choice>

		<log loggingLevel="DEBUG" message="End: route with id ${routeId}" />
    </route>
</routes>
